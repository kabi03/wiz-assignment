name: iac-terraform-ci

on:
  pull_request:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"

  push:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"

  workflow_dispatch:
    inputs:
      tf_action:
        description: "Terraform action (safe default = plan)"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply

jobs:
  terraform:
    name: Terraform CI (fmt, validate, scan, plan)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      # security-events is only needed if uploading SARIF to code scanning
      # security-events: write
      actions: read

    defaults:
      run:
        shell: bash
        working-directory: terraform

    env:
      AWS_REGION: us-east-1
      EKS_CLUSTER_NAME: wiz-exercise
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TFSTATE_BUCKET }}" \
            -backend-config="key=${{ secrets.TFSTATE_KEY }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TFLOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform validate
        run: terraform validate

      # This creates ~/.kube/config on the GitHub runner so Kubernetes/Helm providers can work
      - name: Create kubeconfig for EKS
        run: |
          mkdir -p ~/.kube
          aws eks update-kubeconfig \
            --name "${EKS_CLUSTER_NAME}" \
            --region "${AWS_REGION}"
          echo "kubeconfig created"
          ls -l ~/.kube/config

      # IaC security scan (optional; doesn't block)
      # Produces both SARIF (artifact) and a table output (logs)
      - name: Trivy IaC scan (SARIF)
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: terraform
          severity: CRITICAL,HIGH
          format: sarif
          output: trivy-iac.sarif

      - name: Trivy IaC scan (table to logs)
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: terraform
          severity: CRITICAL,HIGH
          format: table

      # âœ… Upload SARIF as a workflow artifact (works even if Code Scanning is disabled)
      - name: Upload Trivy SARIF artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: trivy-iac-sarif
          path: terraform/trivy-iac.sarif
          if-no-files-found: warn
          retention-days: 7

      # Provide required terraform variables via TF_VAR_* (no committed tfvars files)
      # Also force enable flags to match the already-deployed environment so CI doesn't plan destroys.
      - name: Terraform plan
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.tf_action == 'plan' }}
        env:
          TF_VAR_github_org: ${{ github.repository_owner }}
          TF_VAR_github_repo: ${{ github.event.repository.name }}
          TF_VAR_create_guardduty_detector: "true"
          TF_VAR_enable_securityhub: "true"
        run: terraform plan -no-color

      - name: Terraform apply (manual)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.tf_action == 'apply' }}
        env:
          TF_VAR_github_org: ${{ github.repository_owner }}
          TF_VAR_github_repo: ${{ github.event.repository.name }}
          TF_VAR_create_guardduty_detector: "true"
          TF_VAR_enable_securityhub: "true"
        run: terraform apply -auto-approve
