name: iac-terraform-ci

on:
  pull_request:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"

  push:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"

  workflow_dispatch:
    inputs:
      tf_action:
        description: "Terraform action (safe default = plan)"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply

jobs:
  terraform:
    name: Terraform CI (fmt, validate, scan, plan)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      security-events: write

    defaults:
      run:
        shell: bash
        working-directory: terraform

    env:
      AWS_REGION: us-east-1
      EKS_CLUSTER_NAME: wiz-exercise
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"

    steps:
      # ----------------------------
      # 1. Checkout repo
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # 2. Install Terraform
      # ----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # ----------------------------
      # 3. AWS Auth (OIDC â€“ no static keys)
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ----------------------------
      # 4. Terraform formatting + init
      # ----------------------------
      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TFSTATE_BUCKET }}" \
            -backend-config="key=${{ secrets.TFSTATE_KEY }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TFLOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform validate
        run: terraform validate

      # =========================================================
      # ðŸ”¥ THIS IS THE STEP YOU WERE CONFUSED ABOUT ðŸ”¥
      # =========================================================
      # This creates ~/.kube/config on the GitHub runner
      # so Terraform Kubernetes + Helm providers can work
      - name: Create kubeconfig for EKS
        run: |
          mkdir -p ~/.kube
          aws eks update-kubeconfig \
            --name "${EKS_CLUSTER_NAME}" \
            --region "${AWS_REGION}"
          echo "kubeconfig created"
          ls -l ~/.kube/config

      # ----------------------------
      # 5. IaC Security Scans (soft-fail)
      # ----------------------------
      - name: Trivy IaC scan
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: terraform
          severity: CRITICAL,HIGH
          format: sarif
          output: trivy-iac.sarif

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy-iac.sarif

      # ----------------------------
      # 6. Terraform plan (DEFAULT)
      # ----------------------------
      - name: Terraform plan
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.tf_action == 'plan' }}
        run: terraform plan -no-color

      # ----------------------------
      # 7. Terraform apply (MANUAL ONLY)
      # ----------------------------
      - name: Terraform apply (manual)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.tf_action == 'apply' }}
        run: terraform apply -auto-approve
