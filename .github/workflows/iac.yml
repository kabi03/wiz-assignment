# .github/workflows/iac.yml
name: iac-terraform-ci

on:
  pull_request:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"
  push:
    branches: ["main"]
    paths:
      - "terraform/**"
      - ".github/workflows/iac.yml"
  workflow_dispatch:
    inputs:
      tf_action:
        description: "Terraform action (plan or apply)"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply

jobs:
  terraform_ci:
    name: Terraform CI (fmt, validate, scan, plan)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      EKS_CLUSTER_NAME: wiz-exercise

      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"

      TFSTATE_BUCKET: ${{ secrets.TFSTATE_BUCKET }}
      TFSTATE_KEY: ${{ secrets.TFSTATE_KEY }}
      TFLOCK_TABLE: ${{ secrets.TFLOCK_TABLE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail fast if required secrets are missing
        shell: bash
        run: |
          set -euo pipefail
          for v in AWS_REGION TFSTATE_BUCKET TFSTATE_KEY TFLOCK_TABLE; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret/env: $v"
              exit 1
            fi
          done
          if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
            echo "Missing required secret: AWS_ROLE_TO_ASSUME"
            exit 1
          fi

      - name: Configure AWS credentials (GitHub OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt (check)
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: Terraform init (remote backend)
        working-directory: terraform
        run: |
          terraform init -reconfigure -input=false \
            -backend-config="bucket=${TFSTATE_BUCKET}" \
            -backend-config="key=${TFSTATE_KEY}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TFLOCK_TABLE}" \
            -backend-config="encrypt=true"

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate

      # If your Terraform includes Kubernetes/Helm providers, kubeconfig helps provider init during plan.
      - name: Configure kubeconfig for EKS (for providers)
        run: |
          aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"
          kubectl version --client=true || true

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -qO- https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      # IMPORTANT CHANGE:
      # Output SARIF to repo root as "trivy-iac.sarif" (stable path)
      - name: Trivy IaC scan (SARIF)
        run: |
          trivy config terraform --format sarif --output trivy-iac.sarif

      # IMPORTANT CHANGE:
      # Upload from repo root and FAIL if missing (no more silent warn)
      - name: Upload Trivy SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-iac-sarif
          path: trivy-iac.sarif
          if-no-files-found: error
          retention-days: 7

      # Optional: human-readable console output in logs
      - name: Trivy IaC scan (table)
        run: |
          trivy config terraform --format table

      - name: Terraform plan
        working-directory: terraform
        run: terraform plan -no-color -input=false

      # Manual apply only (protects your stable infra)
      - name: Terraform apply (manual only)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.tf_action == 'apply' }}
        working-directory: terraform
        run: terraform apply -auto-approve -input=false
