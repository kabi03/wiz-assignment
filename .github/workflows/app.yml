name: app-build-scan-push-deploy

on:
  pull_request:
    branches: ["main"]
    paths:
      - "tasky-main/**"
      - ".github/workflows/app.yml"

  push:
    branches: ["main"]
    paths:
      - "tasky-main/**"
      - ".github/workflows/app.yml"

  workflow_dispatch:

jobs:
  build_scan_push_deploy:
    name: Build, Scan, Push, Deploy (Tasky)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read

    # Defaults first, then secrets override if present
    env:
      AWS_REGION: ${{ secrets.AWS_REGION != '' && secrets.AWS_REGION || 'us-east-1' }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME != '' && secrets.EKS_CLUSTER_NAME || 'wiz-exercise' }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY != '' && secrets.ECR_REPOSITORY || 'wiz-exercise-tasky' }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check required config
        run: |
          echo "AWS_REGION=${AWS_REGION}"
          echo "EKS_CLUSTER_NAME=${EKS_CLUSTER_NAME}"
          echo "ECR_REPOSITORY=${ECR_REPOSITORY}"
          echo "IMAGE_TAG=${IMAGE_TAG}"

          if [ -z "${AWS_REGION}" ] || [ -z "${EKS_CLUSTER_NAME}" ] || [ -z "${ECR_REPOSITORY}" ]; then
            echo "ERROR: One or more required env vars are empty (AWS_REGION/EKS_CLUSTER_NAME/ECR_REPOSITORY)."
            echo "Set them as repo secrets OR rely on the defaults in this workflow."
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build image
        working-directory: tasky-main
        run: |
          echo "Building image..."
          docker build -t "${ECR_REPOSITORY}:${IMAGE_TAG}" .

      # Optional: Scan built image (non-blocking)
      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          severity: CRITICAL,HIGH
          format: sarif
          output: trivy-image.sarif

      - name: Upload Trivy image scan results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy-image.sarif

      - name: Tag image for ECR
        run: |
          AWS_ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}" >> $GITHUB_ENV
          echo "ECR_REGISTRY=${ECR_REGISTRY}" >> $GITHUB_ENV
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_ENV

          echo "Tagging -> ${FULL_IMAGE}"
          docker tag "${ECR_REPOSITORY}:${IMAGE_TAG}" "${FULL_IMAGE}"

      - name: Push image to ECR
        run: |
          echo "Pushing ${FULL_IMAGE}"
          docker push "${FULL_IMAGE}"

      - name: Create kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"
          kubectl get ns | head -n 20

      - name: Deploy to EKS
        run: |
          echo "Deploying image: ${FULL_IMAGE}"
          kubectl -n tasky set image deployment/tasky tasky="${FULL_IMAGE}"

          kubectl -n tasky rollout status deployment/tasky --timeout=300s || {
            echo "Rollout timed out or failed. Diagnostics:"
            kubectl -n tasky get pods -o wide || true
            kubectl -n tasky get rs || true
            kubectl -n tasky describe deploy tasky | sed -n '1,220p' || true
            kubectl -n tasky get events --sort-by=.metadata.creationTimestamp | tail -n 50 || true
            exit 1
          }

      - name: Show service/ingress
        run: |
          kubectl -n tasky get svc -o wide || true
          kubectl -n tasky get ingress -o wide || true
